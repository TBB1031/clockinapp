<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clock Out Log - Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      --bg-dark: #0a0e27;
      --bg-gradient-start: #1a1f3a;
      --bg-gradient-end: #0f1729;
      --card-bg: #1a1f3a99;
      --card-border: #6495ed33;
      --primary-blue: #6495ed;
      --text-primary: #e8f1ff;
      --text-secondary: #a0b4d4;
      --text-muted: #6b7a99;
      --accent-cyan: #4dd8ff;
      --accent-purple: #a78bfa;
      --success: #00ff88;
      --danger: #ff4d6d;
      --glow-blue: #6495ed66;
      --glow-cyan: #4dd8ff4d;
      --blue-05: #6495ed0d;
      --blue-08: #6495ed14;
      --blue-10: #6495ed1a;
      --blue-15: #6495ed26;
      --blue-20: #6495ed33;
      --blue-30: #6495ed4d;
      --blue-40: #6495ed66;
      --blue-50: #6495ed80;
      --cyan-06: #4dd8ff0f;
      --cyan-10: #4dd8ff1a;
      --cyan-20: #4dd8ff33;
      --cyan-40: #4dd8ff66;
      --black-20: #00000033;
      --black-30: #0000004d;
      --white-05: #ffffff0d;
      --bg-overlay-40: #0f172966;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 40px 24px;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 50%, var(--blue-08) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, var(--cyan-06) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }

    h1 {
      font-size: 56px;
      font-weight: 700;
      background: linear-gradient(135deg, #a0c4ff 0%, #c9dfff 50%, #6495ed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      margin-bottom: 12px;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    p.subtitle {
      color: var(--text-secondary);
      text-align: center;
      font-size: 20px;
      margin-bottom: 48px;
      font-weight: 200;
      letter-spacing: 0.01em;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 40px;
      padding: 32px;
      margin-bottom: 24px;
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      box-shadow: 
        0 8px 32px #0000004d,
        inset 0 1px 0 #ffffff0d;
      position: relative;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 20px;
      padding: 1px;
      background: linear-gradient(135deg, 
        #6495ed33 0%, 
        transparent 50%, 
        #4dd8ff1a 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: exclude;
      pointer-events: none;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 32px;
      background: #0f172966;
      padding: 6px;
      fill-opacity: 0.5;
      border-radius: 14px;
      border: 1px solid #6495ed1a;
    }

    .tab {
      flex: 1;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      text-align: center;
      font-weight: 500;
      font-size: 14px;
      letter-spacing: 0.01em;
      transition: all 0.3s ease;
      text-decoration: none;
      display: block;
    }

    .tab:hover {
      background: var(--blue-10);
      color: var(--text-primary);
    }

    .tab.active {
      background: var(--primary-blue);
      color: white;
      box-shadow: 0 2px 12px var(--blue-40);
    }

    table {
      width: fit;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 14px 16px;
      text-align: left;
      border-bottom: 1px solid var(--blue-10);
    }

    th {
      background: var(--blue-10);
      color: var(--text-secondary);
      font-weight: 400;
      font-size: 13px;
      letter-spacing: 0.02em;
    }

    td {
      color: var(--text-primary);
    }

    tr:hover {
      background: var(--blue-05);
    }

    .chart-container {
      margin-top: 24px;
      padding: 24px;
      background: var(--bg-overlay-40);
      border-radius: 16px;
      border: 1px solid var(--blue-10);
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      height: 280px;
      gap: 12px;
      padding: 20px 0;
    }

    .bar {
      flex: 1;
      background: linear-gradient(180deg, var(--primary-blue) 0%, #6495ed66 100%);
      border-radius: 8px 8px 0 0;
      position: relative;
      transition: all 0.3s ease;
      min-height: 30px;
      box-shadow: 0 4px 16px var(--blue-30);
    }

    .bar:hover {
      background: linear-gradient(180deg, var(--accent-cyan) 0%, #4dd7fd5b 100%);
      box-shadow: 0 6px 24px var(--cyan-40);
      transform: translateY(-4px);
    }

    .bar-label {
      position: absolute;
      bottom: -28px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      font-weight: 500;
    }

    .bar-value {
      position: absolute;
      top: -28px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      font-weight: 600;
      color: var(--accent-cyan);
      white-space: nowrap;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--card-border);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      box-shadow: 0 4px 20px var(--black-20);
      position: relative;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px var(--blue-30);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 16px;
      padding: 1px;
      background: linear-gradient(135deg, 
        var(--blue-30) 0%, 
        transparent 50%, 
        var(--cyan-20) 100%);
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask-composite: exclude;
      pointer-events: none;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 300;
      background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--primary-blue) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 12px 0 8px;
      letter-spacing: -0.02em;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    h2 {
      color: var(--text-primary);
      font-size: 25px;
      font-weight: 600;
      letter-spacing: -0.01em;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Clock Out Log</h1>
    <p class="subtitle">The world's best employee time tracking system</p>

    <!-- TABS -->
    <div class="tabs">
      <a href="index.html" class="tab">Data Entry</a>
      <a href="analytics.html" class="tab active">Analytics</a>
    </div>

    <!-- CSV UPLOAD -->
    <div class="card">
      <h2>Upload CSV File</h2>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <input type="file" id="csvFileInput" accept=".csv" style="padding: 12px; cursor: pointer;" />
        <button onclick="uploadCSV()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #4dd8ff 0%, #3bc2e6 100%); color: #022c3a; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 16px rgba(77, 216, 255, 0.3); transition: all 0.3s ease;">
          Upload & Process CSV
        </button>
        <div id="uploadStatus" style="text-align: center; font-size: 14px; color: var(--text-secondary);"></div>
      </div>
    </div>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Entries</div>
        <div class="stat-value" id="totalEntries">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Hours</div>
        <div class="stat-value" id="totalHours">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average Hours</div>
        <div class="stat-value" id="avgHours">0</div>
      </div>
    </div>

    <!-- CHART -->
    <div class="card">
      <h2>Hours by Venue</h2>
      <div class="chart-container">
        <div class="bar-chart" id="barChart"></div>
      </div>
    </div>

    <!-- TABLE -->
    <div class="card">
      <h2>All Entries</h2>
      <div>
        <table id="dataTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Venue</th>
              <th>Job Title</th>
              <th>Time In</th>
              <th>Time Out</th>
              <th>Hours</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    function formatTime(date) {
      return date.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    // Load logs
    let logs = JSON.parse(localStorage.getItem("clockLogs")) || [];

    // CSV Upload Function
    function uploadCSV() {
      const fileInput = document.getElementById('csvFileInput');
      const file = fileInput.files[0];
      const statusEl = document.getElementById('uploadStatus');

      if (!file) {
        statusEl.textContent = '⚠️ Please select a CSV file first';
        statusEl.style.color = 'var(--danger)';
        return;
      }

      if (!file.name.endsWith('.csv')) {
        statusEl.textContent = '⚠️ Please upload a valid CSV file';
        statusEl.style.color = 'var(--danger)';
        return;
      }

      statusEl.textContent = '⏳ Processing...';
      statusEl.style.color = 'var(--text-secondary)';

      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const csvContent = e.target.result;
          const parsedLogs = parseCSV(csvContent);
          
          if (parsedLogs.length === 0) {
            statusEl.textContent = '⚠️ No valid data found in CSV';
            statusEl.style.color = 'var(--danger)';
            return;
          }

          // Merge with existing logs or replace
          const replaceData = confirm(`Found ${parsedLogs.length} entries in CSV.\n\nClick OK to REPLACE all existing data.\nClick Cancel to MERGE with existing data.`);
          
          if (replaceData) {
            logs = parsedLogs;
          } else {
            // Merge - add new entries at the beginning
            logs = [...parsedLogs, ...logs];
          }

          localStorage.setItem("clockLogs", JSON.stringify(logs));
          renderAnalytics();
          
          statusEl.textContent = `✅ Successfully loaded ${parsedLogs.length} entries!`;
          statusEl.style.color = 'var(--success)';
          
          // Clear file input
          fileInput.value = '';
          
          setTimeout(() => {
            statusEl.textContent = '';
          }, 5000);
          
        } catch (error) {
          console.error('Error parsing CSV:', error);
          statusEl.textContent = '❌ Error parsing CSV file. Check console for details.';
          statusEl.style.color = 'var(--danger)';
        }
      };

      reader.onerror = function() {
        statusEl.textContent = '❌ Error reading file';
        statusEl.style.color = 'var(--danger)';
      };

      reader.readAsText(file);
    }

    // Parse CSV content
    function parseCSV(csvContent) {
      const lines = csvContent.split('\n').filter(line => line.trim());
      
      if (lines.length < 2) {
        return [];
      }

      // Parse header
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
      
      // Find column indices
      const dateIdx = headers.findIndex(h => h.includes('date'));
      const venueIdx = headers.findIndex(h => h.includes('venue') || h.includes('name'));
      const jobIdx = headers.findIndex(h => h.includes('job') || h.includes('position') || h.includes('title'));
      const timeInIdx = headers.findIndex(h => h.includes('time in') || h.includes('timein') || h.includes('clock in'));
      const timeOutIdx = headers.findIndex(h => h.includes('time out') || h.includes('timeout') || h.includes('clock out'));
      const hoursIdx = headers.findIndex(h => h.includes('hour'));

      if (dateIdx === -1 || venueIdx === -1 || timeInIdx === -1 || timeOutIdx === -1) {
        alert('CSV must contain columns for: Date, Venue, Time In, and Time Out');
        return [];
      }

      const parsedLogs = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        // Parse CSV line (handle quoted fields)
        const fields = parseCSVLine(line);
        
        if (fields.length < 4) continue;

        const date = fields[dateIdx]?.trim() || '';
        const venue = fields[venueIdx]?.trim() || 'Unknown Venue';
        const job = jobIdx !== -1 ? fields[jobIdx]?.trim() : 'General';
        const timeInStr = fields[timeInIdx]?.trim() || '';
        const timeOutStr = fields[timeOutIdx]?.trim() || '';
        
        if (!date || !timeInStr || !timeOutStr) continue;

        // Parse time
        const timeIn = parseTime(timeInStr);
        const timeOut = parseTime(timeOutStr);
        
        // Calculate hours
        let hours;
        if (hoursIdx !== -1 && fields[hoursIdx]) {
          hours = parseFloat(fields[hoursIdx].trim());
        } else {
          hours = parseFloat(hoursBetween(timeIn, timeOut));
        }

        parsedLogs.push({
          name: venue,
          job: job,
          timeInISO: timeIn.toISOString(),
          timeOutISO: timeOut.toISOString(),
          timeInStr: timeInStr,
          timeOutStr: timeOutStr,
          timeInFormatted: formatTime(timeIn),
          timeOutFormatted: formatTime(timeOut),
          hours: hours.toFixed(2),
          date: formatDate(date),
        });
      }

      return parsedLogs;
    }

    // Parse a single CSV line (handles quoted fields with commas)
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }

      result.push(current);
      return result;
    }

    // Parse time from various formats
    function parseTime(timeStr) {
      timeStr = timeStr.trim();
      
      // Try HH:MM format
      if (/^\d{1,2}:\d{2}$/.test(timeStr)) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        const date = new Date();
        date.setHours(hours, minutes, 0, 0);
        return date;
      }
      
      // Try HH:MM:SS format
      if (/^\d{1,2}:\d{2}:\d{2}$/.test(timeStr)) {
        const [hours, minutes, seconds] = timeStr.split(':').map(Number);
        const date = new Date();
        date.setHours(hours, minutes, seconds, 0);
        return date;
      }
      
      // Try HH:MM AM/PM format
      const ampmMatch = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
      if (ampmMatch) {
        let hours = parseInt(ampmMatch[1]);
        const minutes = parseInt(ampmMatch[2]);
        const ampm = ampmMatch[3].toUpperCase();
        
        if (ampm === 'PM' && hours !== 12) hours += 12;
        if (ampm === 'AM' && hours === 12) hours = 0;
        
        const date = new Date();
        date.setHours(hours, minutes, 0, 0);
        return date;
      }
      
      // Default: try to parse as-is
      return new Date(timeStr);
    }

    // Format date from various formats
    function formatDate(dateStr) {
      dateStr = dateStr.trim();
      
      // Try parsing as ISO date or various formats
      const date = new Date(dateStr);
      
      if (!isNaN(date.getTime())) {
        return date.toLocaleDateString();
      }
      
      // If parsing fails, return as-is
      return dateStr;
    }

    // Calculate hours between two times
    function hoursBetween(start, end) {
      let diffMs = end - start;
      
      if (diffMs < 0) {
        diffMs += 24 * 60 * 60 * 1000;
      }
      
      const hours = diffMs / 1000 / 60 / 60;
      return hours.toFixed(2);
    }

    function renderAnalytics() {
      const totalEntries = logs.length;
      let totalHours = 0;
      const venueHours = {};
      const tableRows = [];

      logs.forEach(log => {
        const hours = parseFloat(log.hours);
        totalHours += hours;
        venueHours[log.name] = (venueHours[log.name] || 0) + hours;
        
        tableRows.push(`
          <tr>
            <td>${log.date}</td>
            <td>${log.name}</td>
            <td>${log.job}</td>
            <td>${log.timeInFormatted || formatTime(new Date(log.timeIn))}</td>
            <td>${log.timeOutFormatted || formatTime(new Date(log.timeOut))}</td>
            <td>${log.hours}</td>
          </tr>
        `);
      });

      const avgHours = totalEntries > 0 ? (totalHours / totalEntries).toFixed(2) : 0;

      document.getElementById('totalEntries').textContent = totalEntries;
      document.getElementById('totalHours').textContent = totalHours.toFixed(2);
      document.getElementById('avgHours').textContent = avgHours;

      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = tableRows.join('');

      const chartEl = document.getElementById('barChart');
      chartEl.innerHTML = '';

      let maxHours = 1;
      for (const hours of Object.values(venueHours)) {
        if (hours > maxHours) {
          maxHours = hours;
        }
      }
      
      Object.entries(venueHours).forEach(([venue, hours]) => {
        const bar = document.createElement('div');
        bar.className = 'bar';
        const heightPercent = (hours / maxHours) * 100;
        bar.style.height = `${heightPercent}%`;
        
        bar.innerHTML = `
          <div class="bar-value">${hours.toFixed(1)}h</div>
          <div class="bar-label">${venue}</div>
        `;
        
        chartEl.appendChild(bar);
      });
    }

    renderAnalytics();
  </script>